<!doctype html>
<html>

<head>
    <title>MathJax Tester</title>
    <meta charset="utf-8" />

    <meta name="description" content="A simple LaTeX math equation editor." />
    <meta name="keywords" content="harry7557558, mathjax, latex, math, equation, type" />
    <meta name="author" content="Harry Chen" />
    <meta name="robots" content="index, follow" />

    <script id="mathjax-config-script" type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax:{inlineMath: [["$", "$"]], preview: "none"}, "fast-preview":{disabled: true}, AssistiveMML:{disabled: true}, menuSettings:{inTabOrder: false}, messageStyle: "simple", positionToHash: false});
        MathJax.Hub.Config({ "HTML-CSS": { styles: { ".MathJax nobr": { padding: "0.2em 0.2em" }, } } });
    </script>
    <script type="text/javascript" async="" id="MathJax_JS"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <style>
        #MathJax_MenuFrame {
            opacity: 0.0;
            visibility: hidden;
            display: none;
        }

        .MathJax:focus,
        .mjx-chtml:focus,
        .MathJax_SVG:focus {
            outline-width: 0px;
            outline-style: none;
            outline-color: rgba(255, 255, 255, 0.0);
        }

        #MathJax_Message {
            visibility: hidden;
            display: none;
        }
    </style>
    <style>
        body {
            background-color: rgb(68, 68, 68);
        }

        #LaTeX_Tester {
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            max-width: 1000px;
            background-color: rgb(26, 35, 50);
            width: 656px;
            padding: 24px 20px 30px 20px;
        }

        .title {
            padding: 0px 0px 10px 10px;
            font-size: 20px;
            text-align: left;
            font-family: Consolas;
            font-style: italic;
            font-weight: 600;
            color: rgb(180, 190, 190);
            text-decoration: none;
        }

        #TeX_Input {
            height: 140px;
            width: 620px;
            border: none;
            padding: 10px;
            background-color: rgb(12, 12, 12);
            font-family: Consolas;
            font-size: 14px;
            font-weight: 400;
            color: white;
        }

        #TeX_PreviewBox_Frame {
            margin-left: auto;
            margin-right: auto;
            height: auto;
            min-height: 40px;
            vertical-align: central;
            width: 620px;
            padding: 16px 10px;
            background-color: white;
        }
    </style>
    <script>
        function $(name) {
            return document.getElementById(name);
        }
        $("MathJax_JS").onerror = function () {
            alert("Loading MathJax Failed!");
            $("TeX_Preview").style.color = "red";
        }
    </script>
</head>

<body onload="init();">
    <!-- Latex macros -->
    <div style="height:0px; visibility:hidden; display:none;">
        $\newcommand{\d} {\mathrm{d}}$
        $\newcommand{\e}{\operatorname{e}}$
        $\newcommand{\erf}{\operatorname{erf}}$
        $\newcommand{\abs}{\operatorname{abs}}$
        $\newcommand{\sgn}{\operatorname{sgn}}$
        $\newcommand{\mod}{\operatorname{mod}}$
        $\newcommand{\pmat}[1]{\begin{pmatrix}#1\end{pmatrix}}$
        $\newcommand{\bmat}[1]{\begin{bmatrix}#1\end{bmatrix}}$
        $\newcommand{\vmat}[1]{\begin{vmatrix}#1\end{vmatrix}}$
    </div>
    <div id="LaTeX_Tester">
        <div id="TeX_Input_container">
            <div id="title" class="title">
                <span>type LaTeX here: </span>
                <a href="https://harry7557558.github.io/tools/mathjaxt.html" class="title"
                    style="float:right;display:none">⇒</a>
            </div>
            <textarea id="TeX_Input" type="text" spellcheck="false" data-gramm="false"
                oninput="onInput(event)">\displaystyle f(a) = \dfrac{1}{2\pi i} \oint_\gamma \frac{f(z)}{z-a}\d{z}</textarea>
        </div>
        <div id="TeX_PreviewBox_Frame">
            <div id="TeX_PreviewBox">
                <div id="TeX_Preview"></div>
            </div>
        </div>
        <script>

            function escape(str) {
                return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
            function matchBracket(s, d) {
                if (s[d] == '{') {
                    var st = 1;
                    for (var i = d + 1; i < s.length; i++) {
                        if (s[i] == '{') st++;
                        if (s[i] == '}') st--;
                        if (st == 0) return i;
                    }
                    return -1;
                }
                if (s[d] == '}') {
                    var st = 1;
                    for (var i = d - 1; i >= 0; i--) {
                        if (s[i] == '}') st++;
                        if (s[i] == '{') st--;
                        if (st == 0) return i;
                    }
                    return -1;
                }
                return -1;
            }


            var tex = $("TeX_Input");
            var pref = $("TeX_PreviewBox_Frame");
            var pre = $("TeX_PreviewBox");
            var fom = $("TeX_Preview");
            var maxheight = 0;
            var histht = 0;
            var cookie_enabled = navigator.cookieEnabled;
            var input_history = [];

            function init() {
                String.prototype.splice = function (start, delCount, newSubStr) {
                    return this.slice(0, start) + newSubStr + this.slice(start + Math.abs(delCount));
                };
                String.prototype.insert = function (dir, part) {
                    return this.substr(0, dir) + part + this.substring(dir, this.length);
                }
                String.prototype.erase = function (dir, num) {
                    return this.substr(0, dir) + this.substring(dir + num, this.length);
                }

                if (cookie_enabled) {
                    var getCookie = function getCookie(cname) {
                        var name = cname + "=";
                        var ca = document.cookie.split(';');
                        for (var i = 0; i < ca.length; i++) {
                            var c = ca[i].trim();
                            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
                        }
                        return "";
                    };
                    var s = getCookie("FinInput");
                    if (s != "") tex.value = s;
                }
                else {
                    tex.value = "\\displaystyle f(a) = \\dfrac{1}{2\\pi i} \\oint_\\gamma \\frac{f(z)}{z-a} \\d{z} \n";
                }
                input_history.push([tex.value, tex.value.length]);

                if (document.URL.match("file")) {
                    document.getElementsByTagName('a')[0].style.display = "";
                }
                fom.innerHTML = "$" + escape(tex.value) + "$";

                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

                setTimeout(function () {
                    histht = fom.getBoundingClientRect().height;
                    fom.style.minHeight = histht + "px";
                }, 1000)
            }

            function backup() {
                if (!cookie_enabled) return 0;
                document.cookie = "FinInput=" + tex.value + "; expires=Thu, 18 Dec 2043 12:00:00 GMT";
                if (document.cookie == "") return 0;
                return 1;
            }

            function Render() {
                if (cookie_enabled) backup();
                else document.body.setAttribute("onbeforeunload", "return backup()");

                var ht = fom.getBoundingClientRect().height;
                if (ht > histht) {
                    histht = ht;
                    fom.style.minHeight = histht + "px";
                }

                if (tex.value != "") {
                    fom.innerHTML = "$" + escape(tex.value) + "$";
                    backup();
                }
                else fom.innerText = "";

                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);    // refresh MathJax
            }


            var getCursortPos = function (obj) {
                var cursorIndex = 0;
                if (document.selection) {
                    obj.focus();
                    var range = document.selection.createRange();
                    range.moveStart('character', -obj.value.length);
                    cursorIndex = range.text.length;
                } else if (obj.selectionStart || obj.selectionStart == 0) {
                    cursorIndex = obj.selectionStart;
                }
                return cursorIndex;
            };
            var moveCursortTo = function (obj, pos) {
                obj.setSelectionRange(pos, pos);
            };

            function onInput(event) {
                // auto bracket {}, not 100% accurate
                var pos = getCursortPos(tex);
                var tex_old = input_history[input_history.length - 1][0];
                if (event.inputType == 'insertText') {
                    // type '{'
                    if (event.data == '{' && tex.value[pos - 1] == "{") {
                        if (tex.value[pos] == '{') {
                            tex.value = tex.value.erase(pos, 1);
                            moveCursortTo(tex, pos);
                        }
                        else if (tex.value[pos - 2] != '\\') {
                            tex.value = tex.value.insert(pos, '}');
                            const words = ["dfrac", "frac", "dbinom", "binom"];
                            for (var i = 0; i < words.length; i++) {
                                var word = words[i];
                                var si = pos - word.length - 1;
                                console.log(tex.value[si]);
                                if (tex.value[si - 1] == '\\' && tex.value.substring(si, pos - 1) == word) {
                                    tex.value = tex.value.insert(pos + 1, "{}");
                                    break;
                                }
                            }
                            moveCursortTo(tex, pos);
                        }
                    }
                    // close '}'
                    if (event.data == '}' && tex.value[pos] == '}') {
                        if (tex.value[pos - 2] != '\\') {
                            tex.value = tex.value.erase(pos, 1);
                            moveCursortTo(tex, pos);
                        }
                    }
                    // \left([|<
                    var c = tex.value[pos - 1];
                    if ((c == '(' || c == '[' || c == '|' || c == '<')
                        && tex.value.substring(pos - 6, pos - 1) == "\\left") {
                        tex.value = tex.value.insert(pos, "\\right" +
                            (c == '(' ? ')' : c == '[' ? ']' : c == '|' ? '|' : c == '<' ? '>' : ''));
                        moveCursortTo(tex, pos);
                    }
                }
                else if (event.inputType == 'deleteContentBackward' && tex.value.length == tex_old.length - 1) {
                    // erase '{'
                    if (tex_old[pos] == '{' && tex.value[pos] == '}' && matchBracket(tex_old, pos) == pos + 1) {
                        tex.value = tex.value.erase(pos, 1);
                        moveCursortTo(tex, pos);
                    }
                }
                else console.log(event);

                Render();
                input_history.push([tex.value, getCursortPos(tex)]);
            }
        </script>
    </div>
</body>

</html>